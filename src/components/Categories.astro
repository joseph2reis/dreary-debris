---
import { Code2, BookOpen, Rocket, Lightbulb, Tag } from "lucide-astro";
import type { Post } from "../lib/blogger";

interface Props {
  posts: Post[];
}

const { posts } = Astro.props;

const labelCounts = new Map<string, number>();
for (const p of posts) {
  const labels = p.labels || [];
  for (const l of labels) {
    labelCounts.set(l, (labelCounts.get(l) || 0) + 1);
  }
}

const labels = Array.from(labelCounts.entries())
  .map(([label, count]) => ({ label, count }))
  .sort((a, b) => b.count - a.count);

const normalizeLabel = (value: string) =>
  value
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");

const iconMap: Record<string, any> = {
  tecnologia: Code2,
  tech: Code2,
  fe: BookOpen,
  carreira: Rocket,
  reflexoes: Lightbulb,
  leitura: BookOpen,
};

const colorMap: Record<string, string> = {
  tecnologia: "text-blue-500",
  tech: "text-blue-500",
  fe: "text-purple-500",
  carreira: "text-orange-500",
  reflexoes: "text-yellow-500",
  leitura: "text-teal-500",
};
---

{labels.length > 0 && (
  <section class="py-16 space-y-8">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h2 class="text-3xl font-black tracking-tight text-text">Explorar por temas</h2>
        <p class="mt-2 text-sm text-text-muted">
          Escolha um assunto e encontre posts relacionados com mais rapidez.
        </p>
      </div>
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-sm font-bold text-primary hover:underline"
      >
        Ver todos os posts <span aria-hidden="true">&rarr;</span>
      </a>
    </div>

    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {labels.map((item) => {
        const key = normalizeLabel(item.label);
        const Icon = iconMap[key] || Tag;
        const colorClass = colorMap[key] || "text-primary";

        return (
          <a
            href={`/blog/tag/${encodeURIComponent(item.label)}`}
            class="group relative overflow-hidden rounded-2xl border border-border bg-surface p-5 transition-all duration-300 hover:-translate-y-0.5 hover:border-primary/40 hover:shadow-xl hover:shadow-primary/10"
          >
            <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-primary/0 via-primary/40 to-primary/0 opacity-0 transition-opacity duration-300 group-hover:opacity-100"></div>

            <div class="flex items-center justify-between gap-4">
              <div class="inline-flex h-11 w-11 items-center justify-center rounded-xl border border-border bg-background/80">
                <Icon size={20} class={`inline-block ${colorClass}`} />
              </div>

              <span class="rounded-full border border-border bg-background px-3 py-1 text-xs font-semibold text-text-muted">
                {item.count} {item.count === 1 ? "post" : "posts"}
              </span>
            </div>

            <div class="mt-4 flex items-end justify-between gap-4">
              <div class="text-left">
                <div class="text-base font-extrabold capitalize text-text">{item.label}</div>
                <div class="mt-1 text-xs text-text-muted">Explorar tema</div>
              </div>

              <div class="text-primary transition-transform duration-300 group-hover:translate-x-1">
                &rarr;
              </div>
            </div>
          </a>
        );
      })}
    </div>
  </section>
)}
