---
// src/components/Comments.astro
interface Comment {
  id: number;
  post_id: string;
  author: string;
  content: string;
  created_at: string;
}

interface Props {
  postId: string;
}

const { postId } = Astro.props as Props;
const API_BASE = "https://comentario-api.josenildo2reis.workers.dev";

let comments: Comment[] = [];
try {
  const response = await fetch(
    `${API_BASE}/comments?post_id=${encodeURIComponent(postId)}`,
    {
      headers: {
        Accept: "application/json",
      },
    },
  );

  if (response.ok) {
    comments = await response.json();
  }
} catch (error) {
  console.error("Erro ao buscar comentarios:", error);
}
---

<section class="comments-section max-w-3xl mx-auto px-5 py-10">
  <h2 class="text-2xl font-bold mb-6 text-text">Comentarios</h2>

  <div id="comments-list" class="space-y-6 mb-8">
    {
      comments.length === 0 ? (
        <p class="text-text-muted text-sm">Seja o primeiro a comentar.</p>
      ) : (
        comments.map((comment) => (
          <div class="comment bg-surface p-4 rounded-lg border border-border">
            <div class="flex items-center gap-3 mb-2">
              <strong class="text-text">{comment.author}</strong>
              <time class="text-sm text-text-muted">
                {new Date(comment.created_at).toLocaleDateString("pt-BR")}
              </time>
            </div>
            <p class="text-text">{comment.content}</p>
          </div>
        ))
      )
    }
  </div>

  <div id="comment-message" class="hidden mb-4 p-3 rounded-md text-sm"></div>

  <form
    id="comment-form"
    class="bg-surface p-6 rounded-lg border border-border"
    data-post-id={postId}
  >
    <h3 class="text-lg font-semibold mb-4 text-text">Deixe seu comentario</h3>
    <div class="mb-4">
      <label for="author" class="block text-sm font-medium text-text mb-1"
        >Nome</label
      >
      <input
        type="text"
        id="author"
        name="author"
        required
        class="w-full px-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
      />
    </div>
    <div class="mb-4">
      <label for="content" class="block text-sm font-medium text-text mb-1"
        >Comentario</label
      >
      <textarea
        id="content"
        name="content"
        required
        rows="4"
        class="w-full px-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
      ></textarea>
    </div>
    <button
      type="submit"
      class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
    >
      Enviar comentario
    </button>
  </form>
</section>

<script define:vars={{ postId, API_BASE }}>
  const form = document.getElementById(
    "comment-form",
  ) as HTMLFormElement | null;
  const messageBox = document.getElementById("comment-message");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form as HTMLFormElement);
    const author = formData.get("author")?.toString().trim();
    const content = formData.get("content")?.toString().trim();

    if (!author || !content) {
      showMessage("Preencha todos os campos.", "error");
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/comments`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          post_id: postId,
          author,
          content,
        }),
      });

      const payload = await response.json().catch(() => null);

      if (!response.ok) {
        const errorMessage = payload?.error || "Erro ao enviar comentario";
        throw new Error(errorMessage);
      }

      form.reset();
      if (payload?.status === "pending") {
        showMessage("Comentario enviado e aguardando aprovacao.", "success");
      } else {
        showMessage("Comentario enviado com sucesso!", "success");
      }
    } catch {
      showMessage("Erro ao enviar comentario. Tente novamente.", "error");
    }
  });

  function showMessage(text: string, type: "success" | "error") {
    if (!messageBox) return;

    messageBox.textContent = text;
    messageBox.classList.remove("hidden");

    if (type === "success") {
      messageBox.className =
        "mb-4 p-3 rounded-md text-sm bg-green-500/10 text-green-600 border border-green-500/20";
    } else {
      messageBox.className =
        "mb-4 p-3 rounded-md text-sm bg-red-500/10 text-red-600 border border-red-500/20";
    }

    setTimeout(() => {
      messageBox.classList.add("hidden");
    }, 4000);
  }
</script>
