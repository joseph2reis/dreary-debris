---
// src/components/Comments.astro
interface Comment {
  id: number;
  post_id: string;
  author: string;
  content: string;
  created_at: string;
}

interface Props {
  postId: string;
}

const { postId } = Astro.props;

// Buscar coment치rios existentes no lado do servidor
let comments: Comment[] = [];
try {
  const response = await fetch(
    `https://comentario-api.josenildo2reis.workers.dev/comments?post_id=${postId}`,
  );
  if (response.ok) {
    comments = await response.json();
  }
} catch (error) {
  console.error("Erro ao buscar coment치rios:", error);
}
---

<section class="comments-section max-w-3xl mx-auto px-5 py-10">
  <h2 class="text-2xl font-bold mb-6 text-text">Coment치rios</h2>

  <!-- Lista de coment치rios -->
  <div id="comments-list" class="space-y-6 mb-8">
    {
      comments.map((comment) => (
        <div class="comment bg-surface p-4 rounded-lg border border-border">
          <div class="flex items-center gap-3 mb-2">
            <strong class="text-text">{comment.author}</strong>
            <time class="text-sm text-text-muted">
              {new Date(comment.created_at).toLocaleDateString("pt-BR")}
            </time>
          </div>
          <p class="text-text">{comment.content}</p>
        </div>
      ))
    }
  </div>

  <div id="comment-message" class="hidden mb-4 p-3 rounded-md text-sm"></div>

  <!-- Formul치rio para adicionar coment치rio -->
  <form
    id="comment-form"
    class="bg-surface p-6 rounded-lg border border-border"
    data-post-id={postId}
  >
    <h3 class="text-lg font-semibold mb-4 text-text">Deixe seu coment치rio</h3>
    <div class="mb-4">
      <label for="author" class="block text-sm font-medium text-text mb-1"
        >Nome</label
      >
      <input
        type="text"
        id="author"
        name="author"
        required
        class="w-full px-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
      />
    </div>
    <div class="mb-4">
      <label for="content" class="block text-sm font-medium text-text mb-1"
        >Coment치rio</label
      >
      <textarea
        id="content"
        name="content"
        required
        rows="4"
        class="w-full px-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
      ></textarea>
    </div>
    <button
      type="submit"
      class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
    >
      Enviar Coment치rio
    </button>
  </form>
</section>

<script>
  const form = document.getElementById(
    "comment-form",
  ) as HTMLFormElement | null;
  const messageBox = document.getElementById("comment-message");
  const commentsList = document.getElementById("comments-list");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form as HTMLFormElement);
    const author = formData.get("author")?.toString().trim();
    const content = formData.get("content")?.toString().trim();
    const postId = form.dataset.postId;

    if (!author || !content) {
      showMessage("Preencha todos os campos.", "error");
      return;
    }

    try {
      console.log({ postId });
      const response = await fetch(
        `https://comentario-api.josenildo2reis.workers.dev/comments?post_id=${postId}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            post_id: postId,
            author,
            content,
          }),
        },
      );

      if (!response.ok) {
        throw new Error("Erro ao enviar coment치rio");
      }

      const newComment = await response.json();
      console.log("NEW COMMENT:", newComment);

      // 游댠 Inserir coment치rio no topo da lista
      const commentHTML = `
        <div class="comment bg-surface p-4 rounded-lg border border-border">
          <div class="flex items-center gap-3 mb-2">
            <strong class="text-text">${newComment.author}</strong>
            <time class="text-sm text-text-muted">
              ${new Date(newComment.created_at).toLocaleDateString("pt-BR")}
            </time>
          </div>
          <p class="text-text">${newComment.content}</p>
        </div>
      `;

      commentsList?.insertAdjacentHTML("afterbegin", commentHTML);

      form.reset();
      showMessage("Coment치rio enviado com sucesso! 游꿀", "success");
    } catch (error) {
      showMessage("Erro ao enviar coment치rio. Tente novamente.", "error");
    }
  });

  function showMessage(text: string | null, type: string) {
    if (!messageBox) return;

    messageBox.textContent = text;
    messageBox.classList.remove("hidden");

    if (type === "success") {
      messageBox.className =
        "mb-4 p-3 rounded-md text-sm bg-green-500/10 text-green-600 border border-green-500/20";
    } else {
      messageBox.className =
        "mb-4 p-3 rounded-md text-sm bg-red-500/10 text-red-600 border border-red-500/20";
    }

    setTimeout(() => {
      messageBox.classList.add("hidden");
    }, 4000);
  }
</script>
