---
import Layout from "../../layouts/Layout.astro";
import { Mail, LockKeyhole } from "lucide-astro";

const API_BASE = "https://comentario-api.josenildo2reis.workers.dev";
---

<Layout title="Admin | Caf\u00e9 Com F\u00e9" noindex={true}>
  <section class="max-w-5xl mx-auto px-6 pt-32 pb-20 min-h-screen">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-black text-text">Painel Admin</h1>
      <p class="text-text-muted mt-2">
        Gerenciar coment√°rios.
      </p>
    </header>

    <div id="admin-message" class="hidden mb-6 p-3 rounded-md text-sm"></div>

    <div id="login-card" class="bg-surface border border-border rounded-xl p-6 max-w-md mx-auto">
      <h2 class="text-xl font-semibold text-text mb-4">Entrar</h2>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block text-sm text-text mb-1">Email</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">
              <Mail size={16} />
            </span>
            <input
              id="email"
              name="email"
              type="email"
              required
              placeholder="Digite seu email"
              class="w-full pl-9 pr-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label for="password" class="block text-sm text-text mb-1">Senha</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">
              <LockKeyhole size={16} />
            </span>
            <input
              id="password"
              name="password"
              type="password"
              required
              placeholder="Digite sua senha"
              class="w-full pl-9 pr-3 py-2 border border-border rounded-md bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
        </div>

        <button
          id="login-button"
          type="submit"
          class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors inline-flex items-center justify-center gap-2 disabled:opacity-80 disabled:cursor-not-allowed"
        >
          <span id="login-spinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span id="login-button-text">Entrar</span>
        </button>
      </form>
    </div>

    <div id="dashboard" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-text">Comentarios pendentes</h2>
        <button
          id="logout-button"
          type="button"
          class="px-4 py-2 border border-border rounded-md text-text hover:bg-surface"
        >
          Sair
        </button>
      </div>

      <div id="admin-loading" class="text-text-muted text-sm mb-3 hidden items-center gap-2">
        <span class="w-4 h-4 border-2 border-text-muted/40 border-t-text-muted rounded-full animate-spin"></span>
        <span>Carregando...</span>
      </div>
      <div id="pending-comments" class="space-y-4"></div>
    </div>
  </section>
</Layout>

<script define:vars={{ API_BASE }}>
  const TOKEN_KEY = "comentario_admin_token";

  function initAdminPage() {
    const loginCard = document.getElementById("login-card");
    const dashboard = document.getElementById("dashboard");
    const loginForm = document.getElementById("login-form");
    const logoutButton = document.getElementById("logout-button");
    const pendingComments = document.getElementById("pending-comments");
    const loading = document.getElementById("admin-loading");
    const messageBox = document.getElementById("admin-message");
    const loginButton = document.getElementById("login-button");
    const loginSpinner = document.getElementById("login-spinner");
    const loginButtonText = document.getElementById("login-button-text");

    if (!loginCard || !dashboard || !loginForm || !pendingComments || !messageBox || !loading || !loginButton || !loginSpinner || !loginButtonText) {
      return;
    }

    const getToken = () => localStorage.getItem(TOKEN_KEY);
    const emitSessionChanged = () =>
      window.dispatchEvent(new CustomEvent("admin-session-changed"));

    const setView = (authenticated) => {
      loginCard.classList.toggle("hidden", authenticated);
      dashboard.classList.toggle("hidden", !authenticated);
    };

    const showMessage = (text, type) => {
      messageBox.textContent = text;
      messageBox.classList.remove("hidden");

      if (type === "success") {
        messageBox.className =
          "mb-6 p-3 rounded-md text-sm bg-green-500/10 text-green-600 border border-green-500/20";
      } else {
        messageBox.className =
          "mb-6 p-3 rounded-md text-sm bg-red-500/10 text-red-600 border border-red-500/20";
      }
    };

    const clearMessage = () => {
      messageBox.className = "hidden mb-6 p-3 rounded-md text-sm";
      messageBox.textContent = "";
    };

    const setLoading = (isLoading) => {
      loading.classList.toggle("hidden", !isLoading);
      loading.classList.toggle("flex", isLoading);
    };

    const setLoginLoading = (isLoading) => {
      loginButton.toggleAttribute("disabled", isLoading);
      loginSpinner.classList.toggle("hidden", !isLoading);
      loginButtonText.textContent = isLoading ? "Entrando..." : "Entrar";
    };

    const renderPending = (items) => {
      if (items.length === 0) {
        pendingComments.innerHTML = `
          <div class="bg-surface border border-border rounded-lg p-4 text-text-muted">
            Sem comentarios pendentes no momento.
          </div>
        `;
        return;
      }

      pendingComments.innerHTML = items
        .map(
          (item) => `
            <article class="bg-surface border border-border rounded-lg p-4">
              <header class="flex flex-wrap items-center gap-x-3 gap-y-1 mb-2">
                <strong class="text-text">${escapeHtml(item.author)}</strong>
                <span class="text-xs text-text-muted">post_id: ${escapeHtml(item.post_id)}</span>
                <span class="text-xs text-text-muted">${new Date(item.created_at).toLocaleString("pt-BR")}</span>
              </header>
              <p class="text-text mb-4 whitespace-pre-wrap">${escapeHtml(item.content)}</p>
              <button
                type="button"
                data-action="approve"
                data-comment-id="${item.id}"
                class="px-3 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
              >
                Aprovar comentario
              </button>
              <button
                type="button"
                data-action="reject"
                data-comment-id="${item.id}"
                class="ml-2 px-3 py-2 border border-red-500/30 text-red-500 rounded-md hover:bg-red-500/10 transition-colors"
              >
                Rejeitar comentario
              </button>
            </article>
          `,
        )
        .join("");
    };

    const fetchComments = async () => {
      const token = getToken();
      if (!token) {
        setView(false);
        return;
      }

      setLoading(true);
      clearMessage();

      try {
        const response = await fetch(`${API_BASE}/comments/admin`, {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/json",
          },
        });

        if (response.status === 401) {
          localStorage.removeItem(TOKEN_KEY);
          emitSessionChanged();
          setView(false);
          showMessage("Sessao expirada. Faca login novamente.", "error");
          return;
        }

        const payload = await response.json().catch(() => []);
        if (!response.ok) {
          throw new Error(payload?.error || "Falha ao carregar comentarios");
        }

        const pending = Array.isArray(payload)
          ? payload.filter((item) => item.status === "pending")
          : [];

        setView(true);
        renderPending(pending);
      } catch {
        showMessage("Nao foi possivel carregar comentarios.", "error");
      } finally {
        setLoading(false);
      }
    };

    const moderateComment = async (id, action) => {
      const token = getToken();
      if (!token) {
        setView(false);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/comments/${id}/${action}`, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/json",
          },
        });

        const payload = await response.json().catch(() => null);
        if (!response.ok) {
          const errorMessage = payload?.error || "Falha ao moderar comentario";
          throw new Error(errorMessage);
        }

        if (action === "approve") {
          showMessage("Comentario aprovado com sucesso.", "success");
        } else {
          showMessage("Comentario rejeitado com sucesso.", "success");
        }
        await fetchComments();
      } catch (error) {
        const message = error instanceof Error ? error.message : "Erro inesperado";
        showMessage(message, "error");
      }
    };

    if (!loginForm.dataset.bound) {
      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearMessage();

        const formData = new FormData(loginForm);
        const email = formData.get("email")?.toString().trim();
        const password = formData.get("password")?.toString().trim();

        if (!email || !password) {
          showMessage("Informe email e senha.", "error");
          return;
        }

        try {
          setLoginLoading(true);
          const response = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const payload = await response.json().catch(() => null);
          if (!response.ok || !payload?.token) {
            const errorMessage = payload?.error || "Falha no login";
            throw new Error(errorMessage);
          }

          localStorage.setItem(TOKEN_KEY, payload.token);
          emitSessionChanged();
          showMessage("Login realizado com sucesso.", "success");
          await fetchComments();
        } catch (error) {
          const message = error instanceof Error ? error.message : "Erro inesperado";
          showMessage(message, "error");
        } finally {
          setLoginLoading(false);
        }
      });
      loginForm.dataset.bound = "true";
    }

    if (logoutButton && !logoutButton.dataset.bound) {
      logoutButton.addEventListener("click", () => {
        localStorage.removeItem(TOKEN_KEY);
        emitSessionChanged();
        setView(false);
        pendingComments.innerHTML = "";
        clearMessage();
      });
      logoutButton.dataset.bound = "true";
    }

    if (!pendingComments.dataset.bound) {
      pendingComments.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        const action = target.getAttribute("data-action");
        const commentId = target.getAttribute("data-comment-id");
        if (!action || !commentId) return;

        target.setAttribute("disabled", "true");
        target.textContent = action === "approve" ? "Aprovando..." : "Rejeitando...";

        await moderateComment(commentId, action);
      });
      pendingComments.dataset.bound = "true";
    }

    fetchComments();
  }

  function escapeHtml(value) {
    return String(value)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  document.addEventListener("astro:page-load", initAdminPage);
</script>
