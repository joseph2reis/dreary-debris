---
// src/pages/blog/[slug].astro
import BaseLayout from "../../layouts/Layout.astro";
import { getPosts, getPost } from "../../lib/blogger";
import type { Post } from "../../lib/blogger";
import ProseContent from "../../components/BlogProse.astro";
import RelatedPosts from "../../components/RelatedPosts.astro";
import Giscus from '@giscus/react';

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { postId: post.id },
  }));
}

const { postId } = Astro.props;
const post = await getPost(postId);

if (!post) return Astro.redirect("/404");

const typedPost: Post = post as Post;

// Use publishedAt (ISO) quando disponível; fallback para `date` ou agora
const publishedAt = typedPost.publishedAt || (typedPost as any).published || new Date().toISOString();
const parsed = new Date(publishedAt);
const date = isNaN(parsed.getTime())
  ? ""
  : parsed.toLocaleDateString("pt-BR", { day: "2-digit", month: "long", year: "numeric" });

// Giscus configuration from env
const GISCUS_REPO = import.meta.env.GISCUS_REPO || '';
const GISCUS_REPOSITORY_ID = import.meta.env.GISCUS_REPOSITORY_ID || '';
const GISCUS_CATEGORY = import.meta.env.GISCUS_CATEGORY || '';
const GISCUS_CATEGORY_ID = import.meta.env.GISCUS_CATEGORY_ID || '';
const GISCUS_MAPPING = import.meta.env.GISCUS_MAPPING || 'pathname';
const GISCUS_REACTIONS = import.meta.env.GISCUS_REACTIONS || '1';
const GISCUS_EMIT_METADATA = import.meta.env.GISCUS_EMIT_METADATA || '0';
// Convert known string flags to booleans for the React component
const GISCUS_REACTIONS_BOOL = GISCUS_REACTIONS === '1' || GISCUS_REACTIONS === 'true';
const GISCUS_EMIT_METADATA_BOOL = GISCUS_EMIT_METADATA === '1' || GISCUS_EMIT_METADATA === 'true';
const GISCUS_INPUT_POSITION = import.meta.env.GISCUS_INPUT_POSITION || 'bottom';
const GISCUS_THEME = import.meta.env.GISCUS_THEME || 'preferred_color_scheme';
const GISCUS_LANG = import.meta.env.GISCUS_LANG || 'pt-BR';
---

<BaseLayout
  title={post.title}
  description={post.content.slice(0, 160).replace(/<[^>]*>?/gm, "")}
>
  <article class="max-w-3xl mx-auto px-5 py-10 md:py-16">
    <nav class="flex items-center gap-2 text-sm text-text-muted mb-6">
      <a href="/" class="hover:text-primary transition-colors">Home</a>
      <span>/</span>
      <a href="/blog" class="hover:text-primary transition-colors">Blog</a>
      <span>/</span>
      <span class="text-text truncate max-w-45 sm:max-w-75"
        >{typedPost.title}</span
      >
    </nav>

    <button
      onclick="history.back()"
      class="group mb-8 flex items-center gap-2 text-sm font-medium text-text-muted hover:text-primary transition"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="transition-transform group-hover:-translate-x-1"
      >
        <path d="m15 18-6-6 6-6"></path>
      </svg>
      Voltar
    </button>

    <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-3 text-text">
      {typedPost.title}
    </h1>

    <div
      class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-text-muted mb-10"
    >
      <span
        >Por <strong class="text-text">{typedPost.author.displayName}</strong
        ></span
      >
      <span>•</span>
      <time>{date}</time>
    </div>

    <ProseContent>
      <Fragment set:html={typedPost.content} />
    </ProseContent>

    <RelatedPosts currentId={typedPost.id} posts={await getPosts()} />

    <!-- Giscus React component -->
    {GISCUS_REPO && GISCUS_REPO !== 'owner/repo' ? (
      <section class="mt-12">
        <div id="giscus_container">
          <Giscus
            client:load
            repo={GISCUS_REPO}
            repoId={GISCUS_REPOSITORY_ID}
            category={GISCUS_CATEGORY}
            categoryId={GISCUS_CATEGORY_ID}
            mapping={GISCUS_MAPPING}
            reactionsEnabled={GISCUS_REACTIONS_BOOL ? "1" : "0"}
            emitMetadata={GISCUS_EMIT_METADATA_BOOL ? "1" : "0"}
            inputPosition={GISCUS_INPUT_POSITION}
            theme={GISCUS_THEME}
            lang={GISCUS_LANG}
          />
        </div>
      </section>
    ) : (
      <section class="mt-12 text-center text-sm text-text-muted">
        Comentários desativados. Para ativar, configure <strong>GISCUS_REPO</strong> no arquivo <em>.env</em> com o formato <code>owner/repo</code> e recompile o site.
      </section>
    )}
  </article>
</BaseLayout>
